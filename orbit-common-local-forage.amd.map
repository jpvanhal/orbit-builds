{"version":3,"sources":["orbit-common/local-forage-source.js"],"sourcesContent":["define('orbit-common/local-forage-source', ['exports', 'orbit/main', 'orbit/lib/assert', 'orbit/lib/objects', 'orbit-common/memory-source'], function (exports, Orbit, assert, objects, MemorySource) {\n\n  'use strict';\n\n  var supportsLocalStorage = function() {\n    try {\n      return 'localStorage' in window && window['localStorage'] !== null;\n    } catch(e) {\n      return false;\n    }\n  };\n\n  var now = Date.now || function() {\n    return new Date().getTime();\n  };\n\n  var debounce = function(func, wait, immediate) {\n    var timeout, args, context, timestamp, result;\n\n    var later = function() {\n      var last = now() - timestamp;\n\n      if (last < wait && last >= 0) {\n        timeout = setTimeout(later, wait - last);\n      } else {\n        timeout = null;\n        if (!immediate) {\n          result = func.apply(context, args);\n          if (!timeout) context = args = null;\n        }\n      }\n    };\n\n    return function() {\n      context = this;\n      args = arguments;\n      timestamp = now();\n      var callNow = immediate && !timeout;\n      if (!timeout) timeout = setTimeout(later, wait);\n      if (callNow) {\n        result = func.apply(context, args);\n        context = args = null;\n      }\n\n      return result;\n    };\n  };\n\n  /**\n   Source for storing data with local forage (https://github.com/mozilla/localForage)\n\n   @class LocalForageSource\n   @extends MemorySource\n   @namespace OC\n   @param {OC.Schema} schema\n   @param {Object}    [options]\n   @constructor\n   */\n  var LocalForageSource = MemorySource['default'].extend({\n    init: function(schema, options) {\n      assert.assert('Your browser does not support local storage!', supportsLocalStorage()); //needed as final fallback\n      assert.assert('No valid local forage object given', options['localforage'] !== undefined);\n      assert.assert('Local forage requires Orbit.Promise be defined', Orbit['default'].Promise);\n\n      var _this = this;\n\n      MemorySource['default'].prototype.init.apply(this, arguments);\n\n      options = options || {};\n      this.saveDataCallback = options['saveDataCallback'];\n      this.loadDataCallback = options['loadDataCallback'];\n      this.namespace = options['namespace'] || 'orbit'; // local storage key\n      this._autosave = options['autosave'] !== undefined ? options['autosave'] : true;\n      this.webSQLSize = options['webSQLSize'] !== undefined ? options['webSQLSize'] : 4980736;\n      var autoload = options['autoload'] !== undefined ? options['autoload'] : true;\n      this.localforage = options['localforage'];\n\n      this.localforage.config({\n        name        : 'orbitjs',\n        version     : 1.0,\n        size        : this.webSQLSize,\n        storeName   : this.namespace,\n        description : 'orbitjs localforage adapter'\n      });\n\n      this._isDirty = false;\n\n      this.on('didTransform', debounce(function() {\n        var promise = _this._saveData();\n        if (promise) {\n          promise.then(function() {\n            if (options.saveDataCallback) setTimeout(_this.saveDataCallback, 0);\n          });\n        }\n      }, 200), this);\n\n      if (autoload) this.load().then(function() {\n        if (options.loadDataCallback) setTimeout(options.callback, 0);\n      });\n    },\n\n    load: function() {\n      var _this = this;\n      return new Orbit['default'].Promise(function(resolve, reject) {\n        _this.localforage.getItem(_this.namespace).then(function(storage){\n          if (storage) {\n            _this.reset(storage);\n          }\n          resolve();\n        });\n      });\n    },\n\n    enableAutosave: function() {\n      if (!this._autosave) {\n        this._autosave = true;\n        if (this._isDirty) this._saveData();\n      }\n    },\n\n    disableAutosave: function() {\n      if (this._autosave) {\n        this._autosave = false;\n      }\n    },\n\n    /////////////////////////////////////////////////////////////////////////////\n    // Internals\n    /////////////////////////////////////////////////////////////////////////////\n\n    _saveData: function(forceSave) {\n      var _this = this; //bind not supported in older browsers\n      if (!this._autosave && !forceSave) {\n        this._isDirty = true;\n        return;\n      }\n      return this.localforage.setItem(this.namespace, this.retrieve()).then(\n        function() {\n          _this._isDirty = false;\n        }\n      );\n\n    }\n  });\n\n  exports['default'] = LocalForageSource;\n\n});"],"names":[],"mappings":"AAAA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;","file":"orbit-common-local-forage.amd.js"}